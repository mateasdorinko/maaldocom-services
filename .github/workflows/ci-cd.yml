name: CI/CD Pipeline

on:
  push:
    branches: [main]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
      - 'LICENSE'
  pull_request:
    branches: [main]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
      - 'LICENSE'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  DOTNET_VERSION: '10.0.x'

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore dependencies
        run: dotnet restore

      - name: Build solution
        run: dotnet build --no-restore --configuration Release

      - name: Run tests
        run: dotnet test --no-build --configuration Release --logger:"junit;LogFilePath=${{ github.workspace }}/results/{assembly}-test-results.xml"

      - name: Create test summary
        uses: test-summary/action@v2.4
        with:
          paths: ${{ github.workspace }}/results/*.xml
          output: ${{ github.workspace }}/results/summary.md
          show: "all"
        if: always()

      - name: Add test results to job summary
        run: |
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          cat "${{ github.workspace }}/results/summary.md" >> $GITHUB_STEP_SUMMARY
        if: always()

      - name: Upload build artifacts
        uses: actions/upload-artifact@v6
        with:
          name: build-output
          path: |
            src/**/bin/Release/
            src/**/obj/project.assets.json
            src/**/obj/*.csproj.nuget.*
          retention-days: 1

  build-and-deploy-dev:
    name: Build Container & Deploy to Dev
    needs: build-and-test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: read
      packages: write
      id-token: write
    environment:
      name: Dev
      url: ${{ steps.deploy.outputs.webapp-url }}
    concurrency:
      group: deploy-dev
      cancel-in-progress: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-output

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore dependencies
        run: dotnet restore

      - name: Create EF migration bundle
        run: |
          dotnet tool install --global dotnet-ef
          dotnet ef migrations bundle \
            --project src/MaaldoCom.Services.Infrastructure/MaaldoCom.Services.Infrastructure.csproj \
            --startup-project src/MaaldoCom.Services.Api/MaaldoCom.Services.Api.csproj \
            --configuration Release \
            --no-build \
            --output efbundle \
            --self-contained

      - name: Upload EF migration bundle
        uses: actions/upload-artifact@v6
        with:
          name: efbundle
          path: efbundle
          retention-days: 30

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=sha,prefix=,format=long
            type=raw,value=latest
            type=raw,value=dev-latest

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./src/MaaldoCom.Services.Api/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:buildcache
          cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:buildcache,mode=max

      - name: Deploy to Azure Web App
        id: deploy
        uses: azure/webapps-deploy@v2
        with:
          app-name: app-maaldocomapi-dev-cus
          publish-profile: ${{ secrets.AZURE_DEV_WEBAPP_PUBLISH_PROFILE }}
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

      - name: Run EF migrations
        run: ./efbundle --connection "${{ secrets.AZURE_DEV_MIGRATIONS_CONNECTION_STRING }}" --verbose

      - name: Wait for deployment to stabilize
        run: sleep 30

      - name: Health check
        run: |
          echo "Performing health check on ${{ steps.deploy.outputs.webapp-url }}"
          response=$(curl -s -o /dev/null -w "%{http_code}" --max-time 30 ${{ steps.deploy.outputs.webapp-url }}/health || echo "000")

          if [ "$response" = "200" ]; then
            echo "✅ Health check passed - HTTP $response"
          elif [ "$response" = "000" ]; then
            echo "⚠️  Health check endpoint not reachable - deployment may still be warming up"
            exit 0
          else
            echo "❌ Health check failed - HTTP $response"
            exit 1
          fi
